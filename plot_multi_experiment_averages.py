#!/usr/bin/env python3
"""
Plot average knowledge-agent scores over time for multiple experiment cohorts
on a single set of axes.

Each cohort directory must contain `run_XXXX` subdirectories with an
`experiment.json` file generated by `Environment.save_experiment_data`.

This script reuses `aggregate_cohort` from `plot_swarm_experiment_averages`
to ensure consistency with existing aggregate plots.
"""

from __future__ import annotations

import argparse
from pathlib import Path
from typing import List, Sequence

import matplotlib.pyplot as plt

from plot_swarm_experiment_averages import aggregate_cohort


def _default_label_from_dir(path: Path) -> str:
    """Create a human-friendly label from the directory name."""
    name = path.name
    return name.replace("_", " ").title()


def parse_args() -> argparse.Namespace:
    parser = argparse.ArgumentParser(
        description=(
            "Plot averaged experiment trajectories for multiple cohorts on a single plot. "
            "Each cohort directory should contain run_XXXX subdirectories with experiment.json files."
        )
    )
    parser.add_argument(
        "cohorts",
        nargs="+",
        type=Path,
        help="One or more cohort directories (each containing run_XXXX subdirectories).",
    )
    parser.add_argument(
        "--labels",
        nargs="+",
        help="Optional legend labels for each cohort, in the same order as the cohort directories.",
    )
    parser.add_argument(
        "--output",
        type=Path,
        default=Path("multi_experiment_comparison.png"),
        help="Optional output filepath for the generated plot (PNG).",
    )
    parser.add_argument(
        "--show",
        action="store_true",
        help="Display the plot window after generation.",
    )
    return parser.parse_args()


def plot_multi_cohorts(
    cohort_paths: Sequence[Path],
    labels: Sequence[str],
    *,
    output_path: Path | None = None,
    show: bool = False,
) -> None:
    """Aggregate and plot multiple cohorts on a single figure."""
    if len(cohort_paths) != len(labels):
        raise ValueError("Number of labels must match number of cohort paths.")

    # Dark, modern aesthetic to match per-run plots.
    plt.style.use("dark_background")
    fig, ax = plt.subplots(figsize=(12, 6), facecolor="#0d1117")
    ax.set_facecolor("#0d1117")

    cmap = plt.get_cmap("tab10")

    for idx, (cohort_dir, label) in enumerate(zip(cohort_paths, labels)):
        timesteps, mean, std = aggregate_cohort(cohort_dir)
        color = cmap(idx % 10)

        lower = mean - std
        upper = mean + std

        ax.plot(timesteps, mean, label=label, color=color, linewidth=2.5)
        ax.fill_between(timesteps, lower, upper, color=color, alpha=0.18)

    ax.set_xlabel("Evaluation Step", fontsize=13, color="#c9d1d9", labelpad=10)
    ax.set_ylabel("Average Score", fontsize=13, color="#c9d1d9", labelpad=10)
    ax.set_title(
        "Average Knowledge-Agent Score Over Time (Multiple Cohorts)",
        fontsize=16,
        color="#ffffff",
        fontweight="bold",
        pad=15,
    )
    ax.grid(True, alpha=0.15, color="#30363d", linestyle="-", linewidth=0.5)
    ax.set_axisbelow(True)

    # Style axes and ticks
    for spine in ax.spines.values():
        spine.set_visible(False)
    ax.tick_params(colors="#8b949e", labelsize=10)

    ax.legend()

    if output_path is not None:
        output_path.parent.mkdir(parents=True, exist_ok=True)
        plt.savefig(
            output_path,
            dpi=300,
            facecolor="#0d1117",
            edgecolor="none",
            bbox_inches="tight",
        )

    if show:
        plt.show()
    else:
        plt.close(fig)


def main() -> None:
    args = parse_args()

    cohort_paths: List[Path] = args.cohorts
    if not cohort_paths:
        raise SystemExit("At least one cohort directory must be provided.")

    if args.labels is not None:
        if len(args.labels) != len(cohort_paths):
            raise SystemExit(
                "When using --labels, the number of labels must match the number of cohorts."
            )
        labels: List[str] = list(args.labels)
    else:
        labels = [_default_label_from_dir(p) for p in cohort_paths]

    plot_multi_cohorts(
        cohort_paths,
        labels,
        output_path=args.output,
        show=args.show,
    )


if __name__ == "__main__":
    main()

